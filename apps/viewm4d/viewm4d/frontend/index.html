<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViewM4D - Construction Plan Search</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #141416;
            --bg-tertiary: #1c1c1f;
            --border: #2a2a2d;
            --text-primary: #fafafa;
            --text-secondary: #a1a1a6;
            --text-muted: #636366;
            --accent: #f97316;
            --accent-dim: #c2410c;
            --success: #22c55e;
            --highlight-box: rgba(249, 115, 22, 0.35);
            --highlight-border: #f97316;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        .header {
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-mark {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.02em;
        }

        .logo-text span {
            color: var(--accent);
        }

        .project-selector {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .project-selector label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .project-selector select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            min-width: 200px;
        }

        .project-selector select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Main Layout */
        .main {
            display: grid;
            grid-template-columns: 1fr;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            gap: 2rem;
        }

        /* Search Section */
        .search-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .search-header {
            margin-bottom: 1.5rem;
        }

        .search-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .search-header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .search-form {
            display: flex;
            gap: 1rem;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-btn {
            background: var(--accent);
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-btn:hover {
            background: var(--accent-dim);
        }

        .search-btn:active {
            transform: scale(0.98);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .search-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Loading State */
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading.visible {
            display: flex;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .results-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .results-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .results-count span {
            color: var(--accent);
            font-weight: 600;
        }

        /* Result Cards */
        .result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .result-card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .result-sheet-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .result-file-name {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.5rem;
        }

        .result-trade {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent);
            background: rgba(249, 115, 22, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            white-space: nowrap;
        }

        .result-reason {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding-left: 1rem;
            border-left: 2px solid var(--accent);
        }

        /* Sheet Viewer */
        .sheet-viewer {
            position: relative;
            background: var(--bg-tertiary);
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .sheet-viewer canvas {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .sheet-placeholder {
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }

        .sheet-placeholder svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Bounding Box Overlay - now uses absolute positioning over canvas */
        .bbox-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .bbox-overlay {
            position: absolute;
            border: 3px solid var(--highlight-border);
            background: var(--highlight-box);
            pointer-events: none;
            animation: pulse-box 2s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes pulse-box {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4);
            }
            50% { 
                box-shadow: 0 0 20px 4px rgba(249, 115, 22, 0.2);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* No Results */
        .no-results {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
        }

        .no-results h3 {
            margin-bottom: 0.5rem;
        }

        .no-results p {
            color: var(--text-secondary);
        }

        /* PDF Loading indicator */
        .pdf-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
        }

        .pdf-loading .spinner {
            width: 32px;
            height: 32px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .main {
                padding: 1rem;
            }

            .search-form {
                flex-direction: column;
            }

            .search-btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-mark">M4</div>
            <div class="logo-text">View<span>M4D</span></div>
        </div>
        <div class="project-selector">
            <label for="project-select">Project:</label>
            <select id="project-select">
                <option value="">Select a project...</option>
            </select>
        </div>
    </header>

    <main class="main">
        <section class="search-section">
            <div class="search-header">
                <h2>Search Construction Plans</h2>
                <p>Describe what you're looking for in plain language</p>
            </div>
            <form class="search-form" id="search-form">
                <div class="search-input-wrapper">
                    <input 
                        type="text" 
                        class="search-input" 
                        id="search-input"
                        placeholder="e.g., Where are the ADA requirements for bathroom fixtures?"
                        autocomplete="off"
                    >
                </div>
                <button type="submit" class="search-btn" id="search-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Search
                </button>
            </form>
        </section>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span>Searching plans...</span>
        </div>

        <section class="results-section" id="results-section">
            <div class="results-header">
                <h2>Results</h2>
                <div class="results-count">
                    Found <span id="result-count">0</span> relevant sections
                </div>
            </div>
            <div id="results-container"></div>
        </section>

        <div class="empty-state" id="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v16.5c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9zm3.75 11.625a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
            </svg>
            <h3>Search your construction plans</h3>
            <p>Select a project and describe what you're looking for</p>
        </div>
    </main>

    <script>
        // ============================================================
        // Configuration
        // ============================================================
        
        const API_BASE = window.location.origin;
        
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ============================================================
        // State
        // ============================================================
        
        let currentProject = null;
        
        // ============================================================
        // DOM Elements
        // ============================================================
        
        const projectSelect = document.getElementById('project-select');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const loading = document.getElementById('loading');
        const resultsSection = document.getElementById('results-section');
        const resultsContainer = document.getElementById('results-container');
        const resultCount = document.getElementById('result-count');
        const emptyState = document.getElementById('empty-state');
        
        // ============================================================
        // API Functions
        // ============================================================
        
        async function fetchProjects() {
            try {
                const res = await fetch(`${API_BASE}/api/projects`);
                const data = await res.json();
                return data.projects || [];
            } catch (err) {
                console.error('Failed to fetch projects:', err);
                return [];
            }
        }
        
        async function searchPlans(query, projectId) {
            const res = await fetch(`${API_BASE}/api/search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query,
                    project_id: projectId,
                    max_results: 5
                })
            });
            
            if (!res.ok) {
                throw new Error('Search failed');
            }
            
            return res.json();
        }
        
        // ============================================================
        // PDF Rendering
        // ============================================================
        
        async function renderPdfPage(pdfUrl, pageNumber, container, boundingBox) {
            // Show loading state
            container.innerHTML = `
                <div class="pdf-loading">
                    <div class="spinner"></div>
                    <span>Loading PDF...</span>
                </div>
            `;
            
            try {
                // Load the PDF
                const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
                const page = await pdf.getPage(pageNumber || 1);
                
                // Calculate scale to fit container width
                const containerWidth = container.clientWidth || 800;
                const viewport = page.getViewport({ scale: 1 });
                const scale = Math.min(containerWidth / viewport.width, 2); // Max 2x scale
                const scaledViewport = page.getViewport({ scale });
                
                // Clear container and create canvas
                container.innerHTML = '';
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = scaledViewport.width;
                canvas.height = scaledViewport.height;
                container.appendChild(canvas);
                
                // Render the page
                await page.render({
                    canvasContext: context,
                    viewport: scaledViewport
                }).promise;
                
                // Add bounding box overlay
                if (boundingBox) {
                    const bboxContainer = document.createElement('div');
                    bboxContainer.className = 'bbox-container';
                    bboxContainer.style.width = canvas.width + 'px';
                    bboxContainer.style.height = canvas.height + 'px';
                    
                    const bbox = document.createElement('div');
                    bbox.className = 'bbox-overlay';
                    
                    // Position using normalized coordinates
                    bbox.style.left = (boundingBox.xNorm * canvas.width) + 'px';
                    bbox.style.top = (boundingBox.yNorm * canvas.height) + 'px';
                    bbox.style.width = (boundingBox.wNorm * canvas.width) + 'px';
                    bbox.style.height = (boundingBox.hNorm * canvas.height) + 'px';
                    
                    bboxContainer.appendChild(bbox);
                    container.appendChild(bboxContainer);
                    
                    // Make container relative for absolute positioning
                    container.style.position = 'relative';
                    container.style.display = 'inline-block';
                }
                
            } catch (err) {
                console.error('PDF render error:', err);
                container.innerHTML = `
                    <div class="sheet-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                        </svg>
                        <p>Could not load PDF</p>
                        <p style="font-size: 0.75rem; margin-top: 0.5rem;">${err.message}</p>
                    </div>
                `;
            }
        }
        
        // ============================================================
        // UI Functions
        // ============================================================
        
        function showLoading(show) {
            loading.classList.toggle('visible', show);
            searchBtn.disabled = show;
        }
        
        function showResults(show) {
            resultsSection.classList.toggle('visible', show);
            emptyState.style.display = show ? 'none' : 'block';
        }
        
        function getSheetName(fileName) {
            // Extract just the filename from the full path
            const parts = fileName.split('/');
            return parts[parts.length - 1];
        }
        
        function renderResults(results) {
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>No matching sections found</h3>
                        <p>Try rephrasing your query or using different keywords</p>
                    </div>
                `;
                resultCount.textContent = '0';
                return;
            }
            
            resultCount.textContent = results.length;
            
            resultsContainer.innerHTML = results.map((result, index) => `
                <div class="result-card" data-result-index="${index}">
                    <div class="result-card-header">
                        <div class="result-sheet-info">
                            <h3>${result.title || 'Untitled Section'}</h3>
                            <div class="result-file-name">${getSheetName(result.file_name)}</div>
                            <div class="result-reason">${result.relevance_reason}</div>
                        </div>
                        <div class="result-trade">${result.trade_category || 'General'}</div>
                    </div>
                    <div class="sheet-viewer" id="viewer-${index}">
                        <div class="pdf-loading">
                            <div class="spinner"></div>
                            <span>Loading PDF...</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Load PDFs for each result
            results.forEach((result, index) => {
                const viewer = document.getElementById(`viewer-${index}`);
                const pdfUrl = `${API_BASE}/api/sheets/${currentProject}/${result.sheet_id}/pdf`;
                
                // Get page number from original metadata (default to 1)
                const pageNumber = result.page_number || 1;
                
                renderPdfPage(pdfUrl, pageNumber, viewer, result.bounding_box);
            });
        }
        
        // ============================================================
        // Event Handlers
        // ============================================================
        
        async function handleSearch(e) {
            e.preventDefault();
            
            const query = searchInput.value.trim();
            if (!query || !currentProject) return;
            
            showLoading(true);
            showResults(false);
            
            try {
                const response = await searchPlans(query, currentProject);
                showResults(true);
                renderResults(response.results);
            } catch (err) {
                console.error('Search error:', err);
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>Search failed</h3>
                        <p>Please try again</p>
                    </div>
                `;
                showResults(true);
            } finally {
                showLoading(false);
            }
        }
        
        function handleProjectChange(e) {
            currentProject = e.target.value;
            showResults(false);
            resultsContainer.innerHTML = '';
            searchInput.value = '';
        }
        
        // ============================================================
        // Initialize
        // ============================================================
        
        async function init() {
            // Load projects
            const projects = await fetchProjects();
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.id;
                projectSelect.appendChild(option);
            });
            
            // Auto-select first project
            if (projects.length > 0) {
                projectSelect.value = projects[0].id;
                currentProject = projects[0].id;
            }
            
            // Event listeners
            searchForm.addEventListener('submit', handleSearch);
            projectSelect.addEventListener('change', handleProjectChange);
        }
        
        init();
    </script>
</body>
</html>
